var hashURLArray=new Hash();function Hash(){this.length=0;this.items=new Array();for(var i=0;i<arguments.length;i+=2){if(typeof(arguments[i+1])!='undefined'){this.items[arguments[i]]=arguments[i+1];this.length++;}}this.removeItem=function(in_key){var tmp_previous;if(typeof(this.items[in_key])!='undefined'){this.length--;var tmp_previous=this.items[in_key];delete this.items[in_key];}return tmp_previous;}
this.getItem=function(in_key){return this.items[in_key];}
this.setItem=function(in_key,in_value){var tmp_previous;if(typeof(in_value)!='undefined'){if(typeof(this.items[in_key])=='undefined'){this.length++;}else{tmp_previous=this.items[in_key];}this.items[in_key]=in_value;}return tmp_previous;}
this.hasItem=function(in_key){return typeof(this.items[in_key])!='undefined';}
this.clear=function(){for(var i in this.items){delete this.items[i];}this.length=0;}}function LTrim(value){var re=/\s*((\S+\s*)*)/;return value.replace(re,"$1");}function getLocationHref(){var arr=location.href.split('?');return arr[0];}function RTrim(value){var re=/((\s*\S+)*)\s*/;return value.replace(re,"$1");}function trim(value){return LTrim(RTrim(value));}function getCommentMaxLength(){return 4000;}function doUpdateArticlesIds(){var elements=document.getElementsByName('Article-Ids-List');if(elements.length>0){var requestBatch=new RequestBatch();for(var idx=0;idx<elements.length;idx++){var m=elements[idx];var id=gIDPrefix+trim(m.innerHTML);requestBatch.AddToRequest(new ArticleKey(id));}requestBatch.BeginRequest(DAAPI_PROCESS_URL,onUpdateArticlesCommentsComplete);requestBatch.BeginRequest(DAAPI_PROCESS_URL,onUpdateRecentComments);}}function onUpdateArticlesCommentsComplete(responseBatch){if(responseBatch.Responses.length!=0){for(var idx=0;idx<responseBatch.Responses.length;idx++){var num=responseBatch.Responses[idx].Article.Comments.NumberOfComments;var key=getIdFromKey(responseBatch.Responses[idx].Article.ArticleKey.Key);UpdateArticlesComments(key,num);var rec=responseBatch.Responses[idx].Article.Recommendations.NumberOfRecommendations;var has=responseBatch.Responses[idx].Article.Recommendations.CurrentUserHasRecommended;UpdateArticlesRecommends(key,rec,has);}}}function cleanUpUrl(url){var arr1=url.split('?');if(arr1.length>1){url=arr1[0];}return url;}function fixUpUrl(url){var arr1=url.split('#');if(arr1.length==2){var arr2=arr1[1].split('?');if(arr2.length==2){arr1[1]="?"+arr2[1]+"#"+arr2[0];}else{arr1[1]="#"+arr2[0];}url=arr1[0]+arr1[1];}return url;}function onUpdateRecentComments(responseBatch){var url=cleanUpUrl(this.location.href);var element=document.getElementById('Recent-Comment-Content');if(element!=null){if(responseBatch.Responses.length!=0){var result='';hashURLArray.clear();var arr=new Array();var i=0;for(var idx=0;idx<responseBatch.Responses.length;idx++){var obj=responseBatch.Responses[idx].Article;if(cleanUpUrl(obj.PageUrl).indexOf(url)!=-1){arr[i]=responseBatch.Responses[idx].Article;i=i+1;if(i>=5){break;}}}for(var idx=0;idx<arr.length;idx++){skey=arr[idx].ArticleKey.Key;result+="<li style='display:none' id='Recent-Comment-Content-"+skey+"'></li>";hashURLArray.setItem(skey,cleanUpUrl(arr[idx].PageUrl));}element.innerHTML=result;for(var idx=0;idx<arr.length;idx++){var requestBatch=new RequestBatch();requestBatch.AddToRequest(new CommentPage(new ArticleKey(arr[idx].ArticleKey.Key),1,arr[idx].Comments.NumberOfComments,"TimeStampAscending"));requestBatch.BeginRequest(DAAPI_PROCESS_URL,onUpdateRecentCommentsComplete);}}}}function onUpdateRecentCommentsComplete(responseBatch){if(responseBatch.Responses.length!=0){for(var idx=0;idx<responseBatch.Responses.length;idx++){var obj=responseBatch.Responses[idx];var skey=obj.CommentPage.ArticleKey.Key;var element=document.getElementById('Recent-Comment-Content-'+skey);if(element!=null){if(obj.CommentPage.Comments.length>0){if(obj.CommentPage.Comments[0].CommentBody!=""){element.innerHTML=renderComment(hashURLArray.getItem(skey),obj.CommentPage.Comments[0]);element.style.display='';}}}}}}function renderComment(url,obj){var result='';var name=obj.Author.DisplayName;var comm=obj.CommentBody;if(comm.length>50){comm=comm.substr(0,50);}var time=obj.PostedAtTime_UTC;result='<strong>'+name+' : </strong> '+comm+' <a href="'+fixUpUrl(obj.CommentUrl)+'" title="full comment on: '+comm+'"> read more </a>';return result;}function UpdateArticlesRecommends(key,rec,has){var element=document.getElementById("recommend-"+key);if(element!=null){html="Recommend";if(rec>0){if(rec==1){html=rec+" Recommendation";}else{html=rec+" Recommendations";}}element.innerHTML=html;}}function getIdFromKey(key){var result=key;var data=key.split("_");if(data.length>0){result=data[1];}return result;}function UpdateArticlesComments(key,num){var element=document.getElementById("Article-Comments-Count-"+key);if(element!=null){element.innerHTML=getStringValue(num);}}function getStringValue(NumberOfComments){result="Leave a comment";if(NumberOfComments==1){result="1 Comment";}if(NumberOfComments>1){result=NumberOfComments+" Comments";}return result;}function renderRecomendation(recomendations,funcName,itemName,key){var recommendationHtml="<div id=\"recommend:"+key+"\">";var className='class="SiteLife_Recommend"';var hrefName="href=\"#none\"";var clickName="onclick=\"return gSiteLife.PostRecommendation('Comment','"+key+"','recommend:"+key+"', document.title);\"";var numberOfRecommendations=recomendations.NumberOfRecommendations;if(recomendations.CurrentUserHasRecommended=="True"){recommendationHtml+="<span "+className+">Recommended ("+numberOfRecommendations+")</span>";}else{if(numberOfRecommendations>0){recommendationHtml+="<a "+className+" "+hrefName+" "+clickName+" >Recommend ("+numberOfRecommendations+")</a>";}else{recommendationHtml+="<a "+className+" "+hrefName+" "+clickName+">Recommend</a>";}}recommendationHtml+="</div>";return recommendationHtml;}function renderRecomendation2(recomendations,funcName,itemName,key){var recommendationHtml="";var className='class="SiteLife_Recommend"';var hrefName="href='javascript:"+funcName+"'";var numberOfRecommendations=recomendations.NumberOfRecommendations;if(recomendations.CurrentUserHasRecommended=="True"){recommendationHtml+="<span "+className+"> "+itemName+" was recommended ("+numberOfRecommendations+") times</span>";}else{if(numberOfRecommendations>0){recommendationHtml+="<a "+className+" "+hrefName+" >Recommend this "+itemName+" ("+numberOfRecommendations+")</a>";}else{recommendationHtml+="<a "+className+" "+hrefName+">Recommend this "+itemName+"</a>";}}return recommendationHtml;}function renderAbuse2(recomendations,key){var recommendationHtml="<div id="+"\""+"rpt_"+key+"\""+"><span>";var hrefName="href=\"#none\"";var clickName="onclick=\"ShowReportAbuse(event, document.URL, gSiteLife.__baseUrl + '/AbuseReport/ReportAbuse?plckElementId=rpt_"+key+"&amp;plckTargetKey="+key+"&amp;plckTargetKeyType=Comment'); return false;\"";var idName="id=\""+key+"_RptAbuse\"";var className='class="SiteLife_ReportAbuse"';var numberOfRecommendations=recomendations.AbuseReportCount;if(recomendations.CurrentUserHasReportedAbuse=="True"){recommendationHtml+="<span"+" "+className+" "+idName+">Abuse ("+numberOfRecommendations+")</span>";}else{if(numberOfRecommendations>0){recommendationHtml+="<a"+" "+className+" "+idName+" "+clickName+" "+hrefName+" >Report Abuse ("+numberOfRecommendations+")</a>";}else{recommendationHtml+="<a"+" "+className+" "+idName+" "+clickName+" "+hrefName+">Report Abuse</a>";}}recommendationHtml+="</span></div>";return recommendationHtml;}function renderAbuse(recomendations,commentKey){var recommendationHtml="";var className='class="SiteLife_ReportAbuse"';var funcName="ReportAbuse("+'"'+commentKey+'"'+")";var hrefName="href='javascript:"+funcName+"'";var numberOfRecommendations=recomendations.AbuseReportCount;if(recomendations.CurrentUserHasReportedAbuse=="True"){recommendationHtml+="<span "+className+">Abuse was reported ("+numberOfRecommendations+") times</span>";}else{if(numberOfRecommendations>0){recommendationHtml+="<a "+className+" "+hrefName+" >Report Abuse ("+numberOfRecommendations+")</a>";}else{recommendationHtml+="<a "+className+" "+hrefName+">Report Abuse</a>";}}return recommendationHtml;}function onRecommendArticleComplete(responseBatch){showError("daapiMsg",responseBatch.Messages[0].Message);var recommend=document.getElementById('Comment-Article-Link');if(responseBatch.Responses.length!=0){var article=responseBatch.Responses[0].Article;recommend.innerHTML=renderRecomendation(article.Recommendations,"Recommend()","Story",article.ArticleKey.Key.toString());}else{recommend.innerHTML="<a class=\"SiteLife_Recommend\" href=\"javascript:Recommend()\">Recommend this Story</a>";}}function RenderArticle(article){var result="";result+="<div class=\"comment\" id=\""+article.CommentKey.Key.toString()+"\">\n";result+="<div class=\"comment-content\">\n";result+="<p class=\"comment-userpic\"><a href=\""+article.Author.PersonaUrl+"\"><img class=\"PluckUserAvatar\" alt=\""+article.Author.DisplayName+"\" src=\""+article.Author.ImageUrl+"\" id=\"\"/></a></p>";result+="<p>"+article.CommentBody+"</p>\n";result+="</div>\n";result+="<p class=\"comment-footer\">\n";result+="Posted by:\n";result+="<a title=\""+article.Author.PersonaUrl+"\" href=\""+article.Author.PersonaUrl+"\" >"+article.Author.DisplayName+"</a>  |\n";result+=formatMT4Date(article.PostedAtTime)+"\n";result+="</p>\n";var commentKey=article.CommentKey.Key.toString();var funcName;result+="<table cellspacing=\"0\" cellpadding=\"0\" class=\"Comments_NestedTable\"><tbody><tr><td class=\"Comments_NestedRecommend\">";funcName="RecommendComment(\""+commentKey+"\")";result+=renderRecomendation(article,funcName,"Comment",commentKey);result+="</td>";result+="<td class=\"Comments_NestedReport\">";result+=renderAbuse(article,commentKey);result+="</td></tr></tbody></table>";result+="</div>\n";return result;}function formatMT4Date(dateStr){result=dateStr;try{d=new Date(result);var MonthArray=new Array("January","February","March","April","May","June","July","August","September","October","November","December");year=1900+d.getYear();month=MonthArray[d.getMonth()];day=d.getDate();hr=d.getHours();min=d.getMinutes();if(min<10){min="0"+min;}suff="AM";if(hr>12){hr-=12;suff="PM";}result=month+" "+day+", "+year+" "+hr+":"+min+" "+suff;}catch(err){}return result;}function onGetArticleDetailsComplete(responseBatch){var domElem=document.getElementById('Article-Comments');if(domElem!=null){var htmlText="";if(responseBatch.Responses.length!=0){var Comments=responseBatch.Responses[0].CommentPage.Comments;htmlText+="<div id=\"comments\" class=\"comments\">\n";for(var idx=0;idx<Comments.length;idx++){htmlText+=RenderArticle(Comments[idx]);}htmlText+="</div>\n";htmlText+=doAddPagesToArticleDetails(responseBatch);}domElem.innerHTML=htmlText;}if(gUserType=="1"){hideCommentInput();}else{if(gUserType=="2"){showNameSuggestion();}else{showCommentInput();}}showError("");}function doDrawCommentsCount(NumberOfComments){var domElem=document.getElementById('Article-Comments-Count');if(domElem!=null){domElem.innerHTML=getStringValue(NumberOfComments);}}function hideCommentInput(){var domElem=document.getElementById('Comments-Panel');if(domElem!=null){domElem.style.display="none";}domElem=document.getElementById('pluck-error-message-log');if(domElem!=null){domElem.style.display="";}domElem=document.getElementById('pluck-error-message-empty');if(domElem!=null){domElem.style.display="none";}}function showCommentInput(){var domElem=document.getElementById('Comments-Panel');if(domElem!=null){domElem.style.display="";}domElem=document.getElementById('pluck-error-message-log');if(domElem!=null){domElem.style.display="none";}domElem=document.getElementById('pluck-error-message-empty');if(domElem!=null){domElem.style.display="none";}}function showNameSuggestion(){var domElem=document.getElementById('Comments-Panel');if(domElem!=null){domElem.style.display="none";}domElem=document.getElementById('pluck-error-message-log');if(domElem!=null){domElem.style.display="none";}domElem=document.getElementById('pluck-error-message-empty');if(domElem!=null){domElem.style.display="";}domElem=document.getElementById('MyInfoHref');if(domElem!=null){var mk=readCookie("MKEY");if(mk){domElem.setAttribute('href',domElem.getAttribute('href')+'&mkey='+mk);}}}function getDirtyWords(daapiMessage){daapiMessage=daapiMessage.toLowerCase();var startMarker="(for example: ";var startAt=daapiMessage.indexOf(startMarker)+startMarker.length;var endAt=daapiMessage.lastIndexOf(").");var badWords=daapiMessage.substring(startAt,endAt);return badWords;}function showError(errorType,optMessage){var errorDomElem=document.getElementById("Article-Error");if(errorDomElem!=null){errorDomElem.innerHTML="";switch(errorType){case"":errorDomElem.innerHTML="";break;case"nothing":errorDomElem.innerHTML="Comment was successfully posted.";break;case"emptyComment":errorDomElem.innerHTML="Please enter a comment.";break;case"sendingToFacebook":errorDomElem.innerHTML="<span style='color: blue;'>Sending comment to Facebook... please <a href='javascript:kSiteLifeCustomizations.onsubmitcomplete()'>reload the page</a> if it does not do so automatically in a few seconds.</span>";break;case"notLoadedYet":errorDomElem.innerHTML="Loading... Please wait.";break;case"commentTooLong":errorDomElem.innerHTML="Please shorten your comment to less than "+getCommentMaxLength()+" characters. ";break;case"foulness":errorDomElem.innerHTML="Your comment contained words that are inappropriate for our community ("+optMessage+").";break;case"daapiMsg":if("ok"!=optMessage){errorDomElem.innerHTML="Here the problem: "+optMessage;}break;default:throw new Error("Invalid errorType in showError: "+errorType);}}}function doSubmitComment(){var element=document.getElementById("Comment-Article-Input");if(element!=null){var commentBody=element.value;commentBody=trim(commentBody);commentBody=commentBody.replace(/\n/g,"<br />");if(""!=commentBody){if(commentBody.length<getCommentMaxLength()){var commentAction=new CommentAction(getArticleKey(),getLocationHref(),document.title,commentBody);var request=new RequestBatch();request.AddToRequest(commentAction);request.BeginRequest(DAAPI_PROCESS_URL,onSubmitCommentComplete);}else{showError("commentTooLong");}}else{showError("emptyComment");}}}function onSubmitCommentComplete(responseBatch){var topMessage=responseBatch.Messages[0].Message;if(topMessage.toLowerCase()==="ok"){showError("nothing");doGetArticleDetails(1);doSendNotifyEMail();}else{if(topMessage.indexOf("language filter")>-1){showError("foulness",getDirtyWords(topMessage));}else{showError("daapiMsg",topMessage);}}}function getArticleKey(){return new ArticleKey(gEntryID);}function doGetArticleDetails(pageNum){GetArticleDetails();hideCommentInput();showError("notLoadedYet");if(null==pageNum){pageNum=1;}if(gUserType=="1"){hideCommentInput();}else{if(gUserType=="2"){showNameSuggestion();}else{showCommentInput();}}var requestBatch=new RequestBatch();requestBatch.AddToRequest(new CommentPage(getArticleKey(),10,pageNum,"TimeStampAscending"));requestBatch.BeginRequest(DAAPI_PROCESS_URL,onGetArticleDetailsComplete);}function getStringValue(NumberOfComments){result="Leave a comment";if(NumberOfComments==1){result="1 Comment";}if(NumberOfComments>1){result=NumberOfComments+" Comments";}return result;}function Recommend(){var requestBatch=new RequestBatch();var articleKey=getArticleKey();var recommendAction=new RecommendAction(articleKey,document.title);requestBatch.AddToRequest(recommendAction);requestBatch.BeginRequest(DAAPI_PROCESS_URL,RecommendSubmitted);}function ReportAbuse(strCommentKey){var requestBatch=new RequestBatch();var commentKey=new CommentKey(strCommentKey);var abuseAction=new ReportAbuseAction(commentKey,"Other","Abuse report");requestBatch.AddToRequest(abuseAction);requestBatch.BeginRequest(DAAPI_PROCESS_URL,RecommendCommentSubmitted);}function RecommendComment(strCommentKey){var requestBatch=new RequestBatch();var commentKey=new CommentKey(strCommentKey);var recommendAction=new RecommendAction(commentKey,document.title);requestBatch.AddToRequest(recommendAction);requestBatch.BeginRequest(DAAPI_PROCESS_URL,RecommendCommentSubmitted);}function readCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}return null;}function doAddPagesToArticleDetails(responseBatch){var result="";var Comments=responseBatch.Responses[0].CommentPage;doDrawCommentsCount(Comments.NumberOfComments);if(Comments.NumberOfComments>Comments.NumberPerPage){var NumberOfComments=Comments.NumberOfComments;var NumberPerPage=Comments.NumberPerPage;var pagePage=Comments.OnPage;var currPage=1;while(NumberOfComments>0){NumberOfComments-=NumberPerPage;result+=doAddPageToArticleDetails(currPage,pagePage,NumberOfComments);currPage+=1;}}return"<br /><div style='align:center'>"+result+"</div><br />";}function doAddPageToArticleDetails(currPage,pagePage,NumberOfComments){var result="";if(!((currPage==1)&&(NumberOfComments<=0))){if(currPage==pagePage){result+=" <b>"+currPage+"</b>";}else{result+=" <a href='#' onclick='doGetArticleDetails("+currPage+")'><u style='color:blue'>"+currPage+"</u></a>";}}return result;}function RecommendSubmitted(responseBatch){doUpdateArticlesIds();}function RecommendCommentSubmitted(responseBatch){doGetArticleDetails();}function GetArticleDetails(){var requestBatch=new RequestBatch();var articleKey=getArticleKey();requestBatch.AddToRequest(articleKey);requestBatch.BeginRequest(DAAPI_PROCESS_URL,onRecommendArticleComplete);}function fixURLs(){var arr=document.URL.split("?");var host=arr[0];var matches=$$('a.morelinks');matches.each(function(value,index){var params=value.href.split("?");if(params.length>1){value.href=host+"?"+fixParams(params[1]);}});}function fixParams(params){params1=params.replace("search=","tag=");params1=params1.replace("&__mode=tag","");params1=params1.replace("IncludeBlogs","blog_id");return params1;}function isLogged(){var result=false;var at=readCookie("at");if(at){result=true;}return result;}function getDisplayName(){var h=splitCookie();return h['a'];}function doSendNotifyEMail(){var strTo="";if((gStrTo1!='')&&(gStrTo2!='')){strTo=gStrTo1+"@"+gStrTo2;}var h=splitCookie();var strFrom=h['e'];var name=h['a'];$j("#pluck-comment-input-box").each(function(index,element){var gCommentStr=escape(trim(element.value));if(gCommentStr!=""){if(name!=""){var uri="http://"+gBlogHost+"/email.html";var param="blogName="+gBlogName+"&strTo="+strTo+"&strFrom="+strFrom+"&name="+name+"&commentUrl="+gCommentUrl+"&commentStr="+gCommentStr+"&purl="+gPurl;$j.ajax({type:"GET",url:uri+"?"+param,success:function(msg){}});}}});}function splitCookie(){var result=new Hash();var at=readCookie("at");if(at){var arr=at.split('%26');var tmp="";for(var idx=0;idx<arr.length;idx++){tmp=arr[idx];parts=tmp.split('%3D');if(parts.length>1){n=unescape(parts[0]);v=unescape(parts[1]);result[n]=v;}}}return result;}